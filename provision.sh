#!/bin/sh

# ----------------------------------------------------------------------------------------------------------------------
# Change working directory
# ----------------------------------------------------------------------------------------------------------------------

cd $(dirname $0)

# ----------------------------------------------------------------------------------------------------------------------
# Set environment variables
# ----------------------------------------------------------------------------------------------------------------------

if [ ! -f ./.env ]; then
    echo "ERROR: .env file not found in project root. Please create it from .env.dist file."
    exit 1
fi

. ./.env && ENV_VARS=`cat ./.env`

# ----------------------------------------------------------------------------------------------------------------------
# Pull from SVC
# ----------------------------------------------------------------------------------------------------------------------

git checkout .
git pull

# ----------------------------------------------------------------------------------------------------------------------
# Install salt dependencies
# ----------------------------------------------------------------------------------------------------------------------

sudo apt-get -y install git-core
sudo apt-get -y install python-setuptools
sudo easy_install GitPython
curl -L https://bootstrap.saltstack.com | sudo sh

# ----------------------------------------------------------------------------------------------------------------------
# Run SaltStack States
# ----------------------------------------------------------------------------------------------------------------------

sudo rm /etc/salt/minion
sudo rm -rf /srv/salt/

sudo cp salt/minion.conf /etc/salt/minion
sudo cp -a salt /srv/salt

sudo ${ENV_VARS} salt-call --local state.highstate

# ----------------------------------------------------------------------------------------------------------------------
# Finalize
# ----------------------------------------------------------------------------------------------------------------------

./bin/console cache:clear --env=dev
./bin/console cache:clear --env=prod

sudo chmod -R 775 var
sudo chown -R root:www-data var

sudo service apache2 restart